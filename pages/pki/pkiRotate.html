

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Rotate your keys &mdash; GOV.UK Verify Technical Guide  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="GOV.UK Verify Technical Guide  documentation" href="../../index.html"/>
        <link rel="up" title="Public Key Infrastructure" href="pki.html"/>
        <link rel="next" title="GOV.UK Verify environments" href="../env/env.html"/>
        <link rel="prev" title="Request certificates" href="pkiRequestCert.html"/>
  <link href="../../_static/style.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.4/js.cookie.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54060634-2', 'auto');
    ga('send', 'pageview');

  </script>
  <script type="text/javascript" src="../../_static/CookieBanner.js"></script>
  <script>
    $(function() {new CookieBanner("seen_cookie_message", 28, "ida-cookie-message").launch();});
  </script>


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GOV.UK Verify Technical Guide
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">About this guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch/arch.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../steps/steps.html">Steps to integrate GOV.UK Verify into your service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../saml/saml.html">SAML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ms/ms.html">Local Matching Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../msa/msa.html">Matching Service Adapter</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="pki.html">Public Key Infrastructure</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="pkiWorks.html">How a PKI works</a></li>
<li class="toctree-l2"><a class="reference internal" href="pkiRequestCert.html">Request certificates</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Rotate your keys</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initial-steps-for-all-keys">Initial steps for all keys</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotate-your-service-encryption-key">Rotate your service encryption key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotate-your-service-signing-key">Rotate your service signing key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotate-your-matching-service-adapter-encryption-key">Rotate your Matching Service Adapter encryption key</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rotate-your-matching-service-adapter-signing-key">Rotate your Matching Service Adapter signing key</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../env/env.html">GOV.UK Verify environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../open/opencomponents.html">Open components and contribution</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">GOV.UK Verify Technical Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="pki.html">Public Key Infrastructure</a> &raquo;</li>
      
    <li>Rotate your keys</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rotate-your-keys">
<span id="pkirotate"></span><h1>Rotate your keys<a class="headerlink" href="#rotate-your-keys" title="Permalink to this headline">¶</a></h1>
<p>When the certificates containing your public keys are due to expire, run the key rotation process to replace the keys and certificates. This allows you to introduce a new set of keys and certificates with no service interruption.</p>
<p>As a government service you are responsible for maintaining the following keys:</p>
<ul class="simple">
<li>government service encryption key</li>
<li>government service signing key</li>
<li>Matching Service Adapter (MSA) encryption key</li>
<li>MSA signing key</li>
</ul>
<p>The certificates for these keys are usually issued at the same time. You&#8217;ll probably need to renew them all together.</p>
<div class="section" id="initial-steps-for-all-keys">
<h2>Initial steps for all keys<a class="headerlink" href="#initial-steps-for-all-keys" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Generate a <a class="reference internal" href="pkiRequestCert.html#pki-gen-private-key"><span>new private key</span></a>.</li>
<li>Generate a <a class="reference internal" href="pkiRequestCert.html#pki-gen-csr"><span>certificate signing request</span></a> and <a class="reference internal" href="pkiRequestCert.html#pki-submit-csr"><span>submit it</span></a> to the IDAP certificate authority.</li>
<li>The IDAP certificate authority issues the new certificate to the government service.</li>
</ol>
</div>
<div class="section" id="rotate-your-service-encryption-key">
<h2>Rotate your service encryption key<a class="headerlink" href="#rotate-your-service-encryption-key" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Add the new private encryption key to your service endpoint. Your service can now use the new and old private keys to decrypt SAML messages.</li>
<li>Send the new certificate to the GOV.UK Verify operations team.</li>
<li>The GOV.UK Verify operations team installs the new certificate on the hub. The GOV.UK Verify hub now uses the new key to encrypt SAML messages for your service.</li>
<li>Remove the old encryption key from your service endpoint.</li>
</ol>
</div>
<div class="section" id="rotate-your-service-signing-key">
<h2>Rotate your service signing key<a class="headerlink" href="#rotate-your-service-signing-key" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Send the new signing certificate to the the GOV.UK Verify operations team.</li>
<li>The GOV.UK Verify operations team installs the new certificate on the GOV.UK Verify hub. The GOV.UK Verify hub now trusts SAML messages signed with the new and old keys.</li>
<li>Replace the old private signing key with the new key on your service endpoint. Your service now signs SAML messages with the new key only.</li>
<li>Inform the GOV.UK Verify operations team that new key is live.</li>
<li>The GOV.UK Verify operations team removes the old certificate from the GOV.UK Verify hub. The GOV.UK Verify hub now trusts SAML messages signed with the new key only.</li>
</ol>
</div>
<div class="section" id="rotate-your-matching-service-adapter-encryption-key">
<h2>Rotate your Matching Service Adapter encryption key<a class="headerlink" href="#rotate-your-matching-service-adapter-encryption-key" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Install the new private encryption key and encryption certificate on the MSA. To do this, add the fields <code class="docutils literal"><span class="pre">privateSecondaryEncryptionKeyConfiguration</span></code> and <code class="docutils literal"><span class="pre">publicSecondaryEncryptionKeyConfiguration</span></code> to the  <a class="reference internal" href="../msa/msaUse.html#yamlfile"><span>YAML configuration file</span></a> as indicated in the highlighted sections below:</li>
</ol>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">privateEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_old.pk8</span>

<span class="hll"><span class="l l-Scalar l-Scalar-Plain">privateSecondaryEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
</span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_new.pk8</span>
</span>
<span class="l l-Scalar l-Scalar-Plain">publicEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_old.crt</span>
 <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD</span>

<span class="hll"><span class="l l-Scalar l-Scalar-Plain">publicSecondaryEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
</span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_new.crt</span>
</span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD</span>
</span></pre></div>
</div>
<p>The MSA can now use both the new and old keys to decrypt SAML messages.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">While both keys are in use, you may see error messages in the logs with the description &#8216;Unwrapping failed&#8217;. These messages appear because the MSA attempts to decrypt the SAML message using each key in turn. You can safely ignore these messages. However, do not ignore any other error messages related to SAML decryption.</p>
</div>
</div></blockquote>
<ol class="arabic simple" start="2">
<li>Send the new certificate to the GOV.UK Verify operations team.</li>
<li>The GOV.UK Verify operations team replaces the old certificate with the new certificate on the GOV.UK Verify hub. The GOV.UK Verify hub now uses the new key to encrypt SAML messages for your service.</li>
<li>Promote the secondary private encryption key and encryption certificate to the primary position.</li>
<li>Remove the old private encryption key and encryption certificate:</li>
</ol>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">privateEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_new.pk8</span>

<span class="l l-Scalar l-Scalar-Plain">publicEncryptionKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_encryption_new.crt</span>
 <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="6">
<li>Restart the MSA. The MSA can no longer use the old key to decrypt SAML messages.</li>
</ol>
</div>
<div class="section" id="rotate-your-matching-service-adapter-signing-key">
<h2>Rotate your Matching Service Adapter signing key<a class="headerlink" href="#rotate-your-matching-service-adapter-signing-key" title="Permalink to this headline">¶</a></h2>
<p id="pki-config-msa-2signkeys-samlmetadata">This procedure involves publishing 2 SAML signing certificates in the MSA SAML metadata.</p>
<ol class="arabic simple">
<li>Send the new signing certificate to the GOV.UK Verify operations team.</li>
<li>Install the new signing certificate on the MSA. To do this, add the field <code class="docutils literal"><span class="pre">publicSecondarySigningKeyConfiguration</span></code> to the <a class="reference internal" href="../msa/msaUse.html#yamlfile"><span>YAML configuration file</span></a>, as indicated in the highlighted section below:</li>
</ol>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">privateSigningKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_signing.pk8</span>

<span class="l l-Scalar l-Scalar-Plain">publicSigningKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_signing.crt</span>
 <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD</span>

<span class="hll"><span class="l l-Scalar l-Scalar-Plain">publicSecondarySigningKeyConfiguration</span><span class="p p-Indicator">:</span>
</span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_signing_new_cert.crt</span>
</span><span class="hll"> <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD/Secondary</span>
</span></pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Check that your service endpoint has loaded the newly generated MSA metadata from: /matching-service/SAML2/metadata. The service endpoint now trusts assertions signed with the new key.</li>
<li>Update the field <code class="docutils literal"><span class="pre">privateSigningKeyConfiguration</span></code> with the new private signing key.</li>
<li>Promote the secondary signing certificate to the primary position.</li>
<li>Remove the old signing certificate:</li>
</ol>
<blockquote>
<div><div class="highlight-yaml"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">privateSigningKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_signing_new.pk8</span>

<span class="l l-Scalar l-Scalar-Plain">publicSigningKeyConfiguration</span><span class="p p-Indicator">:</span>
 <span class="l l-Scalar l-Scalar-Plain">keyUri</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">deploy/keys/test_rp_msa_signing_new.crt</span>
 <span class="l l-Scalar l-Scalar-Plain">keyName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://www.test-rp-ms.gov.uk/SAML2/MD</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="7">
<li>Restart the MSA. SAML messages are now signed with the new key.</li>
<li>Inform the GOV.UK Verify operations team that the new key is live.</li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../env/env.html" class="btn btn-neutral float-right" title="GOV.UK Verify environments" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pkiRequestCert.html" class="btn btn-neutral" title="Request certificates" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
<div>Is there anything wrong with this page? Contact <a title="Contact Verify support" href="mailto:idasupport+onboarding@digital.cabinet-office.gov.uk">idasupport+onboarding@digital.cabinet-office.gov.uk</a> if you have any feedback.</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>