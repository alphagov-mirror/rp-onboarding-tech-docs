

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Install the Matching Service Adapter &mdash; GOV.UK Verify Technical Guide  documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="GOV.UK Verify Technical Guide  documentation" href="../../index.html"/>
        <link rel="up" title="Matching Service Adapter" href="msa.html"/>
        <link rel="next" title="Public Key Infrastructure" href="../pki/pki.html"/>
        <link rel="prev" title="Matching Service Adapter" href="msa.html"/>
  <link href="../../_static/style.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.4/js.cookie.js"></script>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54060634-2', 'auto');
    ga('send', 'pageview');

  </script>
  <script type="text/javascript" src="../../_static/CookieBanner.js"></script>
  <script>
    $(function() {new CookieBanner("seen_cookie_message", 28, "ida-cookie-message").launch();});
  </script>


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GOV.UK Verify Technical Guide
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../index.html">About this guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arch/arch.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../steps/steps.html">Steps to integrate GOV.UK Verify into your service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../saml/saml.html">SAML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ms/ms.html">Local Matching Service</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="msa.html">Matching Service Adapter</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">Install the Matching Service Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#versioning">Versioning</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#obtain-certificates-for-your-matching-service-adapter">Obtain certificates for your Matching Service Adapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-the-matching-service-adapter">Configure the Matching Service Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-a-yaml-configuration-file">Create a YAML configuration file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#adapt-the-yaml-configuration-file">Adapt the YAML configuration file</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-server">In the field <code class="docutils literal"><span class="pre">server:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-matchingserviceadapter">In the field <code class="docutils literal"><span class="pre">matchingServiceAdapter:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-localmatchingservice">In the field <code class="docutils literal"><span class="pre">localMatchingService:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-signingkeys">In the field <code class="docutils literal"><span class="pre">signingKeys:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-encryptionkeys">In the field <code class="docutils literal"><span class="pre">encryptionKeys:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-hub">In the field <code class="docutils literal"><span class="pre">hub:</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#in-the-field-metadata">In the field <code class="docutils literal"><span class="pre">metadata:</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#start-the-matching-service-adapter">Start the Matching Service Adapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#monitoring">Monitoring</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configure-https-proxies">Configure HTTPS Proxies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#secure-your-matching-service-adapter">Secure your Matching Service Adapter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#matching-service-adapter-tls-certificates">Matching Service Adapter TLS certificates</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connect-your-matching-service-adapter-to-the-internet-securely">Connect your Matching Service Adapter to the internet securely</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pki/pki.html">Public Key Infrastructure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../env/env.html">GOV.UK Verify environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shared/glossary.html">Glossary of terms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vershis/vershis.html">Version history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">GOV.UK Verify Technical Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="msa.html">Matching Service Adapter</a> &raquo;</li>
      
    <li>Install the Matching Service Adapter</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="install-the-matching-service-adapter">
<span id="msa-install-msa"></span><span id="msause"></span><h1>Install the Matching Service Adapter<a class="headerlink" href="#install-the-matching-service-adapter" title="Permalink to this headline">Â¶</a></h1>
<p><strong>Prerequisites</strong> - to run the Matching Service Adapter (MSA) you need:</p>
<ul class="simple">
<li>Java Runtime Environment (JRE) version 8</li>
<li>512 MB to 1 GB of RAM, on top of what you need to run your operating system</li>
</ul>
<ol class="arabic simple">
<li>When you have successfully completed a gate review for <a class="reference external" href="http://alphagov.github.io/identity-assurance-documentation/stage3/Stage3.html">Stage 3: Planning</a>, you can download and install the MSA. If you don&#8217;t already have a link to the secure site where you can download the MSA, email <a class="reference external" href="mailto:idasupport+onboarding&#37;&#52;&#48;digital&#46;cabinet-office&#46;gov&#46;uk">idasupport+onboarding<span>&#64;</span>digital<span>&#46;</span>cabinet-office<span>&#46;</span>gov<span>&#46;</span>uk</a>.</li>
<li>Download the MSA zip file to your host. It contains:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li>a jar (java archive) file</li>
<li><a class="reference internal" href="../../shared/glossary.html#gloss-truststore"><span>truststore</span></a> files for non-production environments (the SAML compliance tool and the integration environment) - <code class="docutils literal"><span class="pre">test_ida_hub.ts</span></code> and <code class="docutils literal"><span class="pre">test_ida_metadata.ts</span></code></li>
<li>truststore files for the production environment - <code class="docutils literal"><span class="pre">prod_ida_hub.ts</span></code> and <code class="docutils literal"><span class="pre">prod_ida_metadata.ts</span></code></li>
<li>a sample YAML configuration file for non-production environments  - <code class="docutils literal"><span class="pre">test-config.yml</span></code></li>
<li>a sample YAML configuration file for the production environment  - <code class="docutils literal"><span class="pre">prod-config.yml</span></code></li>
</ul>
</div></blockquote>
<ol class="arabic" start="3">
<li><p class="first">To extract the files, run the following command:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>unzip ida-msa-[MSA build number].zip
</pre></div>
</div>
</li>
<li><p class="first">Optionally, move the truststore files to the environment where you want to use the MSA:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mv prod_ida_hub.ts prod_ida_metadata.ts [path to truststore directory in the production environment]
mv test_ida_hub.ts test_ida_metadata.ts [path to truststore directory in the integration environment]
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>where <code class="docutils literal"><span class="pre">[path</span> <span class="pre">to</span> <span class="pre">truststore</span> <span class="pre">directory...]</span></code> is the location of the truststore â you specify this when you configure the MSA (see the <code class="docutils literal"><span class="pre">trustStore:</span></code> fields in the <a class="reference internal" href="#yamlfile"><span>YAML configuration file</span></a>).</div></blockquote>
<div class="section" id="versioning">
<h2>Versioning<a class="headerlink" href="#versioning" title="Permalink to this headline">Â¶</a></h2>
<p>Typically, GOV.UK Verify releases a new version of the MSA every 2 or 3 months. Some releases are essential updates and we may remove support for older versions. To keep updated, contact the <a class="reference external" href="mailto:idasupport+onboarding&#37;&#52;&#48;digital&#46;cabinet-office&#46;gov&#46;uk">GOV<span>&#46;</span>UK Verify support team</a> to ensure you are on the MSA email distribution list.</p>
</div>
</div>
<div class="section" id="obtain-certificates-for-your-matching-service-adapter">
<span id="msa-certs"></span><h1>Obtain certificates for your Matching Service Adapter<a class="headerlink" href="#obtain-certificates-for-your-matching-service-adapter" title="Permalink to this headline">Â¶</a></h1>
<p>Your MSA needs a signing certificate and an encryption certificate. You must use different certificates for each environment.</p>
<p>To obtain certificates:</p>
<ul class="simple">
<li><a class="reference internal" href="../saml/generateSelfSignedCertificates.html#generateselfsignedcertificates"><span>generate self-signed certificates</span></a> for the SAML compliance tool</li>
<li><a class="reference internal" href="../pki/pkiRequestCert.html#pkirequestcert"><span>request certificates</span></a> from the IDAP certificate authority for the integration and production environments</li>
</ul>
</div>
<div class="section" id="configure-the-matching-service-adapter">
<span id="configuremsa"></span><h1>Configure the Matching Service Adapter<a class="headerlink" href="#configure-the-matching-service-adapter" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="create-a-yaml-configuration-file">
<h2>Create a YAML configuration file<a class="headerlink" href="#create-a-yaml-configuration-file" title="Permalink to this headline">Â¶</a></h2>
<p>When you <a class="reference internal" href="#msa-test-msa"><span>start the MSA</span></a>, you need to supply a YAML configuration file.</p>
<p>The MSA zip file contains two sample YAML configuration files:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">test-config.yml</span></code> for the SAML compliance tool and the integration environment</li>
<li><code class="docutils literal"><span class="pre">prod-config.yml</span></code> for the production environment</li>
</ul>
<p><a class="reference internal" href="#msa-adapt-yaml"><span>Adapt the YAML configuration file</span></a> where required.</p>
<p>Below is the <code class="docutils literal"><span class="pre">test-config.yml</span></code> file:</p>
<div class="highlight-yaml" id="yamlfile"><div class="highlight"><pre><span></span><span class="c1"># Configure the matching service adapter&#39;s server settings here.</span>
<span class="c1"># See http://www.dropwizard.io/1.0.5/docs/manual/configuration.html#servers</span>
<span class="c1"># for more information.</span>
<span class="l l-Scalar l-Scalar-Plain">server</span><span class="p p-Indicator">:</span>
  <span class="c1">#Â Ports on which to listen for normal connections.</span>
  <span class="c1"># See http://www.dropwizard.io/1.0.5/docs/manual/configuration.html#connectors</span>
  <span class="c1"># for information on HTTPS and TLS connections.</span>
  <span class="l l-Scalar l-Scalar-Plain">applicationConnectors</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
  <span class="c1"># Ports on which to listen for admin tasks.</span>
  <span class="c1"># This can probably be set to the above port+1.</span>
  <span class="l l-Scalar l-Scalar-Plain">adminConnectors</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8081</span>

<span class="c1"># Add information about your matching service adapter (MSA) here.</span>
<span class="l l-Scalar l-Scalar-Plain">matchingServiceAdapter</span><span class="p p-Indicator">:</span>
  <span class="c1"># The entityId is used for SAML communication with Verify.</span>
  <span class="l l-Scalar l-Scalar-Plain">entityId</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">my-entity-id</span>
  <span class="c1"># The externalUrl is the internet-facing URL for your MSA.</span>
  <span class="l l-Scalar l-Scalar-Plain">externalUrl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://service.gov.uk/matching-service/POST</span>

<span class="c1"># Configure the URLs for your local matching service here.</span>
<span class="l l-Scalar l-Scalar-Plain">localMatchingService</span><span class="p p-Indicator">:</span>
  <span class="c1"># The matchUrl is where the MSA should post user attributes on a successful match</span>
  <span class="l l-Scalar l-Scalar-Plain">matchUrl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://service.gov.uk/local-matching/match</span>
  <span class="c1"># The accountCreationUrl is where the MSA should post attributes for unknown users</span>
  <span class="l l-Scalar l-Scalar-Plain">accountCreationUrl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">http://service.gov.uk/local-matching/create-account</span>

<span class="c1"># Configure the key pairs used by your MSA for signing SAML messages here.</span>
<span class="l l-Scalar l-Scalar-Plain">signingKeys</span><span class="p p-Indicator">:</span>
  <span class="c1"># The primary signing key is used to sign all messages to Verify.</span>
  <span class="l l-Scalar l-Scalar-Plain">primary</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">publicKey</span><span class="p p-Indicator">:</span>
      <span class="c1"># The certificate (.crt) containing the primary public signing key:</span>
      <span class="l l-Scalar l-Scalar-Plain">certFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_primary_signing.crt</span>
      <span class="c1"># The common name (CN) of that certificate:</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Test MSA Signing</span>
    <span class="l l-Scalar l-Scalar-Plain">privateKey</span><span class="p p-Indicator">:</span>
      <span class="c1"># The PK8 (.pk8) containing the primary private signing key:</span>
      <span class="l l-Scalar l-Scalar-Plain">keyFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_primary_signing.pk8</span>
  <span class="c1"># The public part of the secondary signing key is published in the MSA&#39;s metadata</span>
  <span class="c1"># during key rollovers but is otherwise unused by the MSA.</span>
  <span class="l l-Scalar l-Scalar-Plain">secondary</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">publicKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">certFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_secondary_signing.crt</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Test Another MSA Signing</span>
    <span class="l l-Scalar l-Scalar-Plain">privateKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">keyFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_secondary_signing.pk8</span>

<span class="c1"># Configure the key pairs used by your MSA for encrypting and decrypting SAML</span>
<span class="c1"># messages here. You can configure up to 2 encryption keys at a time and the MSA</span>
<span class="c1"># will attempt decryption with both. Only the first key will be used for encryption.</span>
<span class="l l-Scalar l-Scalar-Plain">encryptionKeys</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">publicKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">certFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_msa_encryption_1.crt</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Test MSA Encryption 1</span>
    <span class="l l-Scalar l-Scalar-Plain">privateKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">keyFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_msa_encryption_1.pk8</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">publicKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">certFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_msa_encryption_2.crt</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Test MSA Encryption 2</span>
    <span class="l l-Scalar l-Scalar-Plain">privateKey</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">keyFile</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_msa_encryption_2.pk8</span>

<span class="c1"># Settings for connecting with the hub can be configured here</span>
<span class="c1"># if necessary.</span>
<span class="l l-Scalar l-Scalar-Plain">hub</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ssoUrl</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://compliance-tool-reference.ida.digital.cabinet-office.gov.uk/SAML2/SSO</span>
  <span class="l l-Scalar l-Scalar-Plain">trustStore</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_ida_hub.ts</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">puppet</span>

<span class="c1"># Settings for obtaining Verify&#39;s metadata can be configured here.</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">url</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">https://compliance-tool-reference.ida.digital.cabinet-office.gov.uk/SAML2/metadata/federation</span>
  <span class="l l-Scalar l-Scalar-Plain">trustStore</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">path</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">test_ida_metadata.ts</span>
    <span class="l l-Scalar l-Scalar-Plain">password</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">puppet</span>

<span class="c1">## Options to add additional logging. By default, logs will be output to console.</span>
<span class="c1">## See http://www.dropwizard.io/1.0.5/docs/manual/configuration.html#logging</span>
<span class="c1">## for more information.</span>
<span class="c1">#logging:</span>
<span class="c1">#  level: INFO</span>
<span class="c1">#  appenders:</span>
<span class="c1">#    - type: file</span>
<span class="c1">#      currentLogFilename: apps-home/test-rp-msa.log</span>
<span class="c1">#      archivedLogFilenamePattern: apps-home/test-rp-msa.log.%d.gz</span>
<span class="c1">#      logFormat: &#39;%-5p [%d{ISO8601,UTC}] %c: %X{logPrefix}%m%n%xEx&#39;</span>
<span class="c1">#    - type: console</span>
<span class="c1">#      logFormat: &#39;%-5p [%d{ISO8601,UTC}] %c: %X{logPrefix}%m%n%xEx&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="adapt-the-yaml-configuration-file">
<span id="msa-adapt-yaml"></span><h2>Adapt the YAML configuration file<a class="headerlink" href="#adapt-the-yaml-configuration-file" title="Permalink to this headline">Â¶</a></h2>
<p>Make the following changes to the YAML configuration file according to the environment where you want to use the MSA. Variations are indicated for the SAML compliance tool and integration and production environments.</p>
<div class="section" id="in-the-field-server">
<h3>In the field <code class="docutils literal"><span class="pre">server:</span></code><a class="headerlink" href="#in-the-field-server" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple">
<li>Enter port numbers for the server application (<code class="docutils literal"><span class="pre">applicationConnectors</span></code>) and admin ports (<code class="docutils literal"><span class="pre">adminConnectors</span></code>).</li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the MSA will be handling SSL termination (typically this will be handled by a proxy or load balancer like HAProxy), or if you don&#8217;t trust the network between the SSL termination endpoint and the MSA, then specify <code class="docutils literal"><span class="pre">https</span></code> rather than <code class="docutils literal"><span class="pre">http</span></code> for the type of connection. For more information, see the guidance in the <a class="reference external" href="http://dropwizard.github.io/dropwizard/1.0.5/docs/manual/configuration.html#https">DropWizard configuration manual</a>.</p>
</div>
</div></blockquote>
</div>
<div class="section" id="in-the-field-matchingserviceadapter">
<h3>In the field <code class="docutils literal"><span class="pre">matchingServiceAdapter:</span></code><a class="headerlink" href="#in-the-field-matchingserviceadapter" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="2">
<li>Enter the <a class="reference internal" href="../../shared/glossary.html#gloss-entityid"><span>entityID</span></a> for the MSA in <code class="docutils literal"><span class="pre">entityId</span></code>. This should reflect the name of your service, for example <code class="docutils literal"><span class="pre">https://&lt;service</span> <span class="pre">name&gt;/MSA</span></code></li>
</ol>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It&#8217;s good practice to use the MSA&#8217;s URI (where the hub will send matching requests) as its entityID, but this isn&#8217;t mandatory.</p>
</div>
</div></blockquote>
<ol class="arabic simple" start="3">
<li>Enter the URI for your MSA in <code class="docutils literal"><span class="pre">externalUrl:</span></code></li>
</ol>
</div>
<div class="section" id="in-the-field-localmatchingservice">
<h3>In the field <code class="docutils literal"><span class="pre">localMatchingService:</span></code><a class="headerlink" href="#in-the-field-localmatchingservice" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="4">
<li>Enter the URI for your local matching service in <code class="docutils literal"><span class="pre">matchUrl:</span></code></li>
<li>If you&#8217;re creating new user accounts when a match isn&#8217;t found (see <a class="reference internal" href="../ms/msCua.html#ms-cua"><span>Create user accounts</span></a>), enter the user account creation URI in <code class="docutils literal"><span class="pre">accountCreationUrl:</span></code></li>
</ol>
</div>
<div class="section" id="in-the-field-signingkeys">
<h3>In the field <code class="docutils literal"><span class="pre">signingKeys:</span></code><a class="headerlink" href="#in-the-field-signingkeys" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="6">
<li>Enter the paths of the primary SAML signing keys and certificates for your MSA in <code class="docutils literal"><span class="pre">primary:</span></code></li>
</ol>
<blockquote>
<div><ul class="simple">
<li>for the compliance tool, <a class="reference internal" href="../saml/generateSelfSignedCertificates.html#generateselfsignedcertificates"><span>generate self-signed certificates</span></a></li>
<li>you&#8217;ll use different keys and certificates for the integration and production environments - see <a class="reference internal" href="../pki/pkiRequestCert.html#pkirequestcert"><span>Request certificates</span></a>.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To convert a private key to PKCS#8 DER format, run the following command: <code class="docutils literal"><span class="pre">openssl</span> <span class="pre">pkcs8</span> <span class="pre">-topk8</span> <span class="pre">-nocrypt</span> <span class="pre">-in</span> <span class="pre">server.key</span> <span class="pre">-out</span> <span class="pre">server.pk8</span> <span class="pre">-outform</span> <span class="pre">DER</span></code></p>
</div>
</div></blockquote>
</div>
<div class="section" id="in-the-field-encryptionkeys">
<h3>In the field <code class="docutils literal"><span class="pre">encryptionKeys:</span></code><a class="headerlink" href="#in-the-field-encryptionkeys" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="7">
<li>Enter the paths and names of the encryption keys and certificates for your MSA in <code class="docutils literal"><span class="pre">encryptionKeys</span></code>.  The names are used to identify the certificates in the metadata so should be meaningful and unique, for example, <code class="docutils literal"><span class="pre">signing_1</span></code> and <code class="docutils literal"><span class="pre">encryption_1</span></code>.</li>
</ol>
</div>
<div class="section" id="in-the-field-hub">
<h3>In the field <code class="docutils literal"><span class="pre">hub:</span></code><a class="headerlink" href="#in-the-field-hub" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="8">
<li>In <code class="docutils literal"><span class="pre">trustStore:</span></code> <code class="docutils literal"><span class="pre">path:</span></code> , specify the path to your hub truststore file for the appropriate environment:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li>for the SAML compliance tool and the integration environment, use the provided <code class="docutils literal"><span class="pre">test_ida_hub.ts</span></code> file (this is the default setting in the <code class="docutils literal"><span class="pre">test-config.yml</span></code> file)</li>
<li>for the production environment, use the provided <code class="docutils literal"><span class="pre">prod_ida_hub.ts</span></code> file (this is the default setting in the <code class="docutils literal"><span class="pre">prod-config.yml</span></code> file)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="in-the-field-metadata">
<h3>In the field <code class="docutils literal"><span class="pre">metadata:</span></code><a class="headerlink" href="#in-the-field-metadata" title="Permalink to this headline">Â¶</a></h3>
<ol class="arabic simple" start="9">
<li>Edit the <code class="docutils literal"><span class="pre">url:</span></code> value and specify the location where the MSA accesses the SAML metadata:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li>for the SAML compliance tool, use the default setting in the <code class="docutils literal"><span class="pre">test-config.yml</span></code> file</li>
<li>for the integration environment, enter: <code class="docutils literal"><span class="pre">https://www.integration.signin.service.gov.uk/SAML2/metadata/federation</span></code> in the <code class="docutils literal"><span class="pre">test-config.yml</span></code> file</li>
<li>for the production environment, use the default setting in the <code class="docutils literal"><span class="pre">prod-config.yml</span></code> file</li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="10">
<li>In <code class="docutils literal"><span class="pre">trustStore:</span></code> <code class="docutils literal"><span class="pre">path:</span></code>, specify the path to your metadata truststore file for the appropriate environment:</li>
</ol>
<blockquote>
<div><ul class="simple">
<li>for the SAML compliance tool and the integration environment, use the provided <code class="docutils literal"><span class="pre">test_ida_metadata.ts</span></code> file (this is the default setting in the <code class="docutils literal"><span class="pre">test-config.yml</span></code> file)</li>
<li>for the production environment, use the provided <code class="docutils literal"><span class="pre">prod_ida_metadata.ts</span></code> file (this is the default setting in the <code class="docutils literal"><span class="pre">prod-config.yml</span></code> file)</li>
</ul>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="start-the-matching-service-adapter">
<span id="msa-test-msa"></span><h1>Start the Matching Service Adapter<a class="headerlink" href="#start-the-matching-service-adapter" title="Permalink to this headline">Â¶</a></h1>
<p>To start using the MSA, run the following command, supplying the path to your configuration file:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>java -jar [filename].jar server [path to configuration file].yml
</pre></div>
</div>
<p>You can now run <a class="reference internal" href="../saml/samlComplianceTool.html#samlcthubmsa"><span>SAML compliance tests between the hub and your MSA</span></a>. To help <a class="reference internal" href="../ms/msBuild.html#msbuild"><span>build your local matching service</span></a>, you can use the <a class="reference internal" href="../ms/msBuild.html#respondjsonmr"><span>example of the JSON request</span></a> that the MMSA posts to your service.</p>
</div>
<div class="section" id="monitoring">
<h1>Monitoring<a class="headerlink" href="#monitoring" title="Permalink to this headline">Â¶</a></h1>
<p>When the MSA is installed in your <a class="reference internal" href="../env/env.html#env"><span>integration or production environment</span></a>, health checks run every 60 seconds to ensure that the MSA is functioning correctly. They test:</p>
<ul class="simple">
<li>connectivity</li>
<li>that the MSA accepts the hub signature</li>
<li>that the hub accepts the MSA signature</li>
</ul>
</div>
<div class="section" id="configure-https-proxies">
<h1>Configure HTTPS Proxies<a class="headerlink" href="#configure-https-proxies" title="Permalink to this headline">Â¶</a></h1>
<p>The MSA supports HTTP and HTTPS proxies configured by Java properties.</p>
<p>For information on configuring HTTPS proxies, see <a class="reference external" href="http://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html">http://docs.oracle.com/javase/8/docs/technotes/guides/net/proxies.html</a>.</p>
</div>
<div class="section" id="secure-your-matching-service-adapter">
<h1>Secure your Matching Service Adapter<a class="headerlink" href="#secure-your-matching-service-adapter" title="Permalink to this headline">Â¶</a></h1>
<div class="section" id="matching-service-adapter-tls-certificates">
<h2>Matching Service Adapter TLS certificates<a class="headerlink" href="#matching-service-adapter-tls-certificates" title="Permalink to this headline">Â¶</a></h2>
<p>The table below shows the root certificate authorities that GOV.UK Verify trusts for HTTPS connections to your matching service in the <a class="reference internal" href="../env/env.html#env"><span>integration and production environments</span></a>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="24%" />
<col width="23%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Root certificate authority</th>
<th class="head">Common name</th>
<th class="head">X509v3 subject key identifier</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>AddTrust External CA Root</td>
<td>AddTrust External CA Root</td>
<td>AD:BD:98:7A:34:B4:26:F7:FA:C4:26:54:EF:03:BD:E0:24:CB:54:1A</td>
</tr>
<tr class="row-odd"><td>GeoTrust Global CA</td>
<td>GeoTrust Global CA</td>
<td>C0:7A:98:68:8D:89:FB:AB:05:64:0C:11:7D:AA:7D:65:B8:CA:CC:4E</td>
</tr>
<tr class="row-even"><td>QuoVadis Root CA 2</td>
<td>QuoVadis Root CA 2</td>
<td>1A:84:62:BC:48:4C:33:25:04:D4:EE:D0:F6:03:C4:19:46:D1:94:6B</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For the SAML compliance tool, use <a class="reference internal" href="../saml/generateSelfSignedCertificates.html#generateselfsignedcertificates"><span>self-signed certificates</span></a>.</p>
</div>
<p>If you want to use a root certificate authority for your matching service that isnât in the above table, raise a ticket with us by sending an email to <a class="reference external" href="mailto:idasupport+onboarding&#37;&#52;&#48;digital&#46;cabinet-office&#46;gov&#46;uk">idasupport+onboarding<span>&#64;</span>digital<span>&#46;</span>cabinet-office<span>&#46;</span>gov<span>&#46;</span>uk</a>. Weâll review your chosen root certificate authority before adding it to this list.</p>
<p>When you raise a ticket, indicate the chain of trust with your SSL/TLS certificate. You&#8217;ll also need the chain of trust when you configure your server.</p>
</div>
<div class="section" id="connect-your-matching-service-adapter-to-the-internet-securely">
<h2>Connect your Matching Service Adapter to the internet securely<a class="headerlink" href="#connect-your-matching-service-adapter-to-the-internet-securely" title="Permalink to this headline">Â¶</a></h2>
<p>Your MSA must only respond to matching requests from the GOV.UK Verify hub, otherwise thereâs a risk of user data being compromised.</p>
<p>The MSA checks that matching service requests are genuine by checking their cryptographic signatures.</p>
<p>To ensure that only the GOV.UK Verify hub can access the MSA, make sure your MSA:</p>
<ul>
<li><p class="first">is only exposed as HTTPS endpoints</p>
</li>
<li><p class="first">only uses strong recent versions of TLS (for example TLS 1.2); turn off obsolete and insecure versions (for example SSLv1, SSLv2, and SSLv3)</p>
</li>
<li><p class="first">supports multiple strong cipher suites</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">GOV.UK Verify will remove support for TLS cipher suites if serious weaknesses become known. Having multiple suites provides resilience.</p>
</div>
</li>
<li><p class="first">allows requests and health checks only from the IP addresses of hub services provided by your engagement lead</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Each MSA should communicate with only 1 hub service (SAML compliance tool, integration environment, or production environment).</p>
</div>
</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../pki/pki.html" class="btn btn-neutral float-right" title="Public Key Infrastructure" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="msa.html" class="btn btn-neutral" title="Matching Service Adapter" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
<div>Is there anything wrong with this page? Contact <a title="Contact Verify support" href="mailto:idasupport+onboarding@digital.cabinet-office.gov.uk">idasupport+onboarding@digital.cabinet-office.gov.uk</a> if you have any feedback.</div>


</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>