.. _pkiRotate:


Rotate your keys
==================

When the certificates containing your public keys are due to expire, run the key rotation process to replace the keys and certificates.

As a government service you are responsible for maintaining the following keys:

* government service encryption key
* government service signing key
* Matching Service Adapter encryption key
* Matching Service Adapter signing key

The certificates for these keys are usually issued at the same time. You'll probably need to renew them all together.


Initial steps for all keys
----------------------------------

#. Generate a :ref:`new private key <pki_gen_private_key>`.
#. Generate a :ref:`certificate signing request <pki_gen_csr>` and :ref:`submit it <pki_submit_csr>` to the IDAP certificate authority.
#. The IDAP certificate authority issues the new certificate to the government service.


Rotate your service encryption key
-----------------------------------

Use the procedure below if your service supports 2 encryption keys simultaneously.

#. Add the new private encryption key to your service endpoint. This means that your service can use the new and old private keys to decrypt SAML messages.
#. Send the new certificate to the GOV.UK Verify operations team.
#. The GOV.UK Verify operations team installs the new certificate on the hub. This means that the GOV.UK Verify hub uses the new key to encrypt SAML messages for your service.
#. Remove the old encryption key from your service endpoint.

Use the procedure below if your service does not support 2 encryption keys simultaneously.  

#. Send the new encryption certificate to the the GOV.UK Verify operations team.
#. Take your service offline.
#. The GOV.UK Verify operations team installs the new certificate on the hub. This means that the GOV.UK Verify hub uses the new key to encrypt SAML messages for your service.
#. Replace the old private encryption key with the new key on your service endpoint. This means that your service uses only the new key to decrypt SAML messages.
#. Put your service back online.


Rotate your service signing key
----------------------------------

#. Send the new signing certificate to the the GOV.UK Verify operations team.
#. The GOV.UK Verify operations team installs the new certificate on the GOV.UK Verify hub. This means that the GOV.UK Verify hub trusts SAML messages signed with the new and old keys.
#. Replace the old private signing key with the new key on your service endpoint. This means that your service signs SAML messages with the new key only.
#. Inform the GOV.UK Verify operations team that new key is live. 
#. The GOV.UK Verify operations team removes the old certificate from the GOV.UK Verify hub. This means that the GOV.UK Verify hub trusts SAML messages signed with the new key only.

Rotate your Matching Service Adapter encryption key
-----------------------------------------------------

The Matching Service Adapter supports 2 encryption keys simultaneously. Use the procedure below to rotate your key.

1. First install the new private encryption key on the Matching Service Adapter. Then configure the Matching Service Adapter for 2 encryption keys. To do this, add the new private encryption key to the Matching Service Adapter configuration file as indicated in the highlighted section below:

  .. code-block:: yaml
     :emphasize-lines: 4-8

     privateSigningKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_signing.pk8

     privateEncryptionKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_encryption_new.pk8

     privateSecondaryEncryptionKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_encryption_old.pk8
   
     publicSigningKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_signing.crt
      keyName: http://www.test-rp-ms.gov.uk/SAML2/MD

     publicEncryptionKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_encryption.crt
      keyName: http://www.test-rp-ms.gov.uk/SAML2/MD
 
  The Matching Service Adapter can now use both the new and old keys to decrypt SAML messages.

2. Send the new certificate to the GOV.UK Verify operations team.
3. The GOV.UK Verify operations team replaces the old certificate with the new certificate on the GOV.UK Verify hub. This means that the GOV.UK Verify hub uses the new key to encrypt SAML messages for your service.
4. Remove the old private encryption key from the Matching Service Adapter. The Matching Service Adapter can no longer use the old key to decrypt SAML messages.

.. note:: While both keys are in use, you may see error messages in the logs with the description "Unwrapping failed". These messages appear because the Matching Service Adapter attempts to decrypt the SAML message using each key in turn. You can safely ignore these messages. However, do not ignore any other error messages related to SAML decryption.


.. _pki_config_msa_2keys:

Configure the Matching Service Adapter for 2 encryption keys
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^



Rotate your Matching Service Adapter signing key
--------------------------------------------------

There are 3 methods to rotate your Matching Service Adapter signing key. We recommend that you use SAML metadata as this minimises service downtime and reduces the complexity of the the key rotation procedure.  For more information, see :ref:`saml_access_metadata`.

.. _pki_config_msa_2signkeys_SAMLmetadata:

Use SAML metadata
^^^^^^^^^^^^^^^^^^^

This procedure allows zero service downtime when you rotate your Matching Service Adapter signing key. It involves publishing 2 SAML signing certificates in the Matching Service Adapter SAML metadata.

.. important:: To use this procedure you must be using version 493 or later of the Matching Service Adapter. Contact your engagement lead if you want to update your Matching Service Adapter. 

1. Send the new signing certificate to the GOV.UK Verify operations team.
2. Configure your Matching Service Adapter to support 2 signing certificates. To do this, add the field ``publicSecondarySigningKeyConfiguration`` to the Matching Service Adapter configuration file as indicated in the highlighted section below:

  .. code-block:: yaml
     :emphasize-lines: 4-10

     privateSigningKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_signing.pk8

     publicSigningKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_signing.crt
      keyName: http://www.test-rp-ms.gov.uk/SAML2/MD

     publicSecondarySigningKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_signing_new_cert.crt
      keyName: http://www.test-rp-ms.gov.uk/SAML2/MD/Secondary

     publicEncryptionKeyConfiguration:
      keyUri: deploy/keys/test_rp_msa_encryption.crt
      keyName: http://www.test-rp-ms.gov.uk/SAML2/MD

3. Check that your service endpoint has loaded the newly generated Matching Service Adapter metadata from: /matching-service/SAML2/metadata. This means the service endpoint trusts assertions signed with the new key.
4. Update the field ``privateSigningKeyConfiguration`` with the new private signing key and restart the Matching Service Adapter. This means that SAML messages are now signed with the new key.
5. Inform the GOV.UK Verify operations team that the new key is live.
6. Remove the old signing certificate from the Matching Service Adapter configuration file.


.. _pki_config_msa_2signkeys_service2keys:

Your service supports 2 Matching Service Adapter signing keys 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Use the procedure below if your service supports 2 Matching Service Adapter signing keys simultaneously but you are not using SAML metadata from your Matching Service Adapter.

#. Send the new signing certificate to the GOV.UK Verify operations team.
#. The GOV.UK Verify operations team installs the new certificate on the GOV.UK Verify hub. This means that the GOV.UK hub trusts SAML messages signed with the new and old certificates.
#. Add the new certificate to your service endpoint. This means that your service trusts SAML messages signed with the new and old keys.
#. Replace the old private signing key with the new key on the Matching Service Adapter. This means that SAML is now signed with the new key.
#. Remove the old certificate from your service endpoint. This means that your service trusts SAML messages signed with the new private signing key only.
#. Inform the GOV.UK Verify operations team that the new key is live.
#. The GOV.UK Verify operations team removes the old certificate from the GOV.UK Verify hub. This means that the GOV.UK Verify hub trusts SAML messages signed with the new private signing key only.


.. _pki_config_msa_2signkeys_serviceNo2keys:

Your service does not support 2 Matching Service Adapter signing keys 
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Use the procedure below if your service does not support 2 Matching Service Adapter signing keys simultaneously. This involves service downtime during key rotation.

#. Take your service offline.
#. Replace the old certificate with the new certificate on your service endpoint. This means that your service trusts SAML messages signed with the new key.
#. Replace the old private signing key with the new key on the Matching Service Adapter. This means that SAML is now signed with the new key.
#. Inform the GOV.UK Verify operations team that the new key is live.
#. The GOV.UK Verify operations team removes the old certificate from the GOV.UK Verify hub. This means that the GOV.UK Verify hub trusts SAML messages signed with the new private signing key only.
#. Put your service back online.


