.. _msBuild:

Build a local matching service
================================

Even if your service doesnâ€™t need to perform matching, you must still build a local matching service because it also:

* creates the :ref:`hashed persistent identifier <gloss_hashpid>` 
* creates and signs the final assertion sent to your service - for more information, see :ref:`samlWorks`
* acts as the :ref:`trust anchor <gloss_trustanchor>` for your service because the final assertion is created in your service's security domain

.. _ms_strat:

Define your matching strategy
--------------------------------

A matching strategy defines the most efficient and effective way of matching assured identities to your service records. The strategy depends on the quality and completeness of available data sources and the types of evidence users can provide.

A local matching service carries out a risk-based match to find the local record. Exact matching of identity data is rarely possible for many reasons:

* transcription errors 
* spelling mistakes 
* incorrect data in your service's data sources, for example, if someone has moved house but not informed the service
* use of shortened names or nicknames which refer to the same person, for example, William Smith, Bill Smith and David William Smith

Your local matching service must be able to handle these issues. You may decide to:

* widen the initial query to make sure that relevant records are not missed, then narrow the query on the results to make sure false positives are not returned; for example, search for last name, date of birth, and postcode, then run further matching on the results and apply a confidence score
* try synonym matching against combinations of first name and last name, possibly transposing them to maximise the chances of finding a match
 
Matching considerations
~~~~~~~~~~~~~~~~~~~~~~~~

When you define your matching strategy you need to:

* prepare for matching with customer data aggregation and data cleansing 
* define the confidence level required for a successful match and how to score the confidence level, for example:

  * 100% match confidence means that all elements from the matching dataset fully match the local record 
  * 80% match confidence might mean that the first name, last name, and date of birth match, but the address is showing a mismatch 


* define the rules for successful matching, which may include what to do with:

  * synonyms for first names, for example, **William** and **Bill**
  * transpositions of multiple part names, for example, **Anna-Marie**, **Jane** and **Anna, Marie-Jane**
  * transpositions errors of day and month in the date of birth, for example, **04/10/78** and **10/04/78**

* define the level of 'fuzzy matching' that is acceptable when an exact match is not found - this allows a match that, although not 100%, is above a service-defined threshold
* manage the risk of incorrect matching by defining what happens when:
 
  * there's no match - you can :ref:`create a new account <ms_cua>` for the user
  * there are multiple matches - you can implement :ref:`matching cycle 3 <ms_mc3>`

* analyse your data sources in the light of your matching strategy, so you can test and refine your strategy before launching alpha or beta services

.. note:: We recommend that you discuss your matching strategy with your engagement lead. They can organise technical support if needed.






