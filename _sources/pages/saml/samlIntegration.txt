.. _samlIntegration:

Build your service: SAML integration 
=====================================

Your government service must be able to send SAML authentication requests to, and receive SAML responses from, the GOV.UK Verify hub. 

You can choose from a wide range of libraries and off-the-shelf products to add the SAML functionality to your service, for example, Shibboleth-SP (service provider). Contact your engagement lead if you need further information. 

When you've built your service you must:

* :ref:`run SAML compliance tests <samlComplianceTool>` 
* :ref:`run end-to-end testing in the integration environment <envEndToEndTests>` 

.. _saml_access_metadata:

Access the SAML metadata 
-------------------------

The SAML metadata contains the :ref:`SAML encryption and signing certificates <pki_encrypt_signing>` used within the GOV.UK Verify federation. The preferred way to distribute and access certificates is through the SAML metadata. The IDAP certificate authority issues certificates. See :ref:`pkiWorks`.

The GOV.UK Verify federation uses:

  **Federation metadata** 

    The federation metadata is located at `https://www.signin.service.gov.uk/SAML2/metadata/federation <https://www.signin.service.gov.uk/SAML2/metadata/federation>`_.

    This metadata is signed. It includes entity descriptors that define the roles of the GOV.UK Verify hub and the identity providers.

  **Matching Service Adapter metadata** 

   The Matching Service Adapter metadata is located in your Matching Service Adapter at: /matching-service/SAML2/metadata

   This metadata is generated by your Matching Service Adapter and contains your Matching Service Adapter certificates. It includes an entity descriptor that defines the role of the Matching Service Adapter.

.. _saml_consume_responses:

Consume responses using SAML metadata
----------------------------------------

Your service must be able to receive (consume) SAML responses that are issued by the GOV.UK Verify hub. 

We recommend that you use the federation metadata and the Matching Service Adapter metadata to do this. You must first :ref:`access the metadata <saml_access_metadata>`.

1. Validate the signature on the response. This checks that the response is correctly signed by the GOV.UK Verify hub
   (entityID: ``https://signin.service.gov.uk``). 

   You can use the hub X509 signing certificates contained in the federation metadata to validate this signature.
 
2. Decrypt the assertion.

3. Validate the signature on the assertion contained in the response. This assertion is generated and signed by your Matching Service Adapter. 

   You can use the X509 signing certificate contained in the Matching Service Adapter metadata to validate this signature.

.. caution:: Use this procedure with care. You must trust assertions signed by the Matching Service Adapter only. The GOV.Verify hub never issues assertions for consumption by the service endpoint, so make sure that itâ€™s *not* possible to trust the hub to issue assertions.







